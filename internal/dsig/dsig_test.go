package dsig

import (
	"crypto/x509"
	"encoding/base64"
	"fmt"
	"testing"
)

func TestVerify(t *testing.T) {
	asn1Data, err := base64.StdEncoding.DecodeString("MIIDdDCCAlygAwIBAgIGAYl5fwdeMA0GCSqGSIb3DQEBCwUAMHsxFDASBgNVBAoTC0dvb2dsZSBJ\nbmMuMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MQ8wDQYDVQQDEwZHb29nbGUxGDAWBgNVBAsTD0dv\nb2dsZSBGb3IgV29yazELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWEwHhcNMjMwNzIx\nMTcyODM0WhcNMjgwNzE5MTcyODM0WjB7MRQwEgYDVQQKEwtHb29nbGUgSW5jLjEWMBQGA1UEBxMN\nTW91bnRhaW4gVmlldzEPMA0GA1UEAxMGR29vZ2xlMRgwFgYDVQQLEw9Hb29nbGUgRm9yIFdvcmsx\nCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A\nMIIBCgKCAQEA2C9GM4JrOIk8k0B7rRJSwnx4jNdDFNou7LnWZ6B0wQrhPKc7KhbB+705M+u96o7A\nPSTpmbbW/ZlI47/tctCiQOMgBjc/10pxI/smEONG99juQeSgpdkYMR9HTXO/8PTbGyKswyWsGLJo\nM4Pe8qcSnwUiSMjDCcC56WV3MOAjwoYywYsZXm3y/Ug0Fb/thbK2lzJWu6aVDgssXfF9DQ0a42wk\nB1EbtWy0Lo1oIjHOjUXtoK58sXEp5p13x/4wGYYvSaSK6hFvBgJ53R41wDRcce0Our5r3xA6LjjU\npiQLj+mfntz4+WkGF4Ok6ibwdGiG1SRtLcG+KyusHn+Qu9JHGQIDAQABMA0GCSqGSIb3DQEBCwUA\nA4IBAQAx11yQ6quWJzr9Nk7lkD8Wtj7PRAvpyKgwjW8i4OGXf3cvSM5tc2uiMc/0lgqU7Nlx0iQS\nx5R8L4tPisFuESIHREz8jtQpp24U4n2XG8+E+gUo2yYw7D8Xha3l2JFlqCIwx/zlidEb8E8VYVxw\nSUR6ywKpLdX7VJa02qpbUEhOTi86EBOYOfSxOnVokMFsKZ0pV/kAozxdQPo76xFxc+/nRDVQsZ9Y\n6Tl4tE7KvzV1OrQN3T8b2sXGejZvc28XrOLdyWnPTx48rqKmwy0XVJQY3XdtkjIZSkWHpUU6L9XX\nxHhtr/PB0PrIqJDN35q3sMxmIW41d/NdR8AcJZVDEje9")
	if err != nil {
		panic(err)
	}

	cert, err := x509.ParseCertificate(asn1Data)
	if err != nil {
		panic(err)
	}

	fmt.Println(Verify(cert, []byte("<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?><saml2p:Response xmlns:saml2p=\"urn:oasis:names:tc:SAML:2.0:protocol\" Destination=\"https://example.com/accounts/bfeb03a0-6022-4862-9bbf-5a4d7608db35/saml/acs\" ID=\"_35b2b0263e784387af9b4e7ba1dd8b04\" IssueInstant=\"2023-11-16T21:20:27.514Z\" Version=\"2.0\"><saml2:Issuer xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\">https://accounts.google.com/o/saml2?idpid=C029op2ga</saml2:Issuer><saml2p:Status><saml2p:StatusCode Value=\"urn:oasis:names:tc:SAML:2.0:status:Success\"/></saml2p:Status><saml2:Assertion xmlns:saml2=\"urn:oasis:names:tc:SAML:2.0:assertion\" ID=\"_6f7e3b62751ed5bf0adab64936da1e67\" IssueInstant=\"2023-11-16T21:20:27.514Z\" Version=\"2.0\"><saml2:Issuer>https://accounts.google.com/o/saml2?idpid=C029op2ga</saml2:Issuer><ds:Signature xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:SignedInfo><ds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/><ds:SignatureMethod Algorithm=\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\"/><ds:Reference URI=\"#_6f7e3b62751ed5bf0adab64936da1e67\"><ds:Transforms><ds:Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"/><ds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/></ds:Transforms><ds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\"/><ds:DigestValue>TpzmWoL9EUgbX7RBnA5/I/7PPguo7+wDNi7GjgWH5cI=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>Pvzge2elr/yP26Y6DsqMEvsfC3BCjZzPbjh1zWpniFEfu+SooT5JezHbxSH+Zua71l1Fl9gsPn2r\n    DGqe8bkxQ7u6YZtdpBY3aE8ON39+q21dDkdjuw9ubGGhp8uzWq4T5ijfBBzJXFjuapYjdz76gCdQ\n    3bxnCCQfutaa0DCvwP6ChDbHRWYSPXrkyyWqqegCYCtnY1GCE1WKWYogNzVK5Ik+Y5zNsuy4NoJS\n    XstWoB/6boenl9G6it+0xee2Pu3QoORwn3Nrq1baBBTguI+SLwzzBfEKCZ93EfV3b6s6JF5SgFJG\n    UigcV+kPJ0HHDgVlg/leQSzz0w3QiytM5S0z8g==</ds:SignatureValue><ds:KeyInfo><ds:X509Data><ds:X509SubjectName>ST=California,C=US,OU=Google For Work,CN=Google,L=Mountain View,O=Google Inc.</ds:X509SubjectName><ds:X509Certificate>MIIDdDCCAlygAwIBAgIGAYl5fwdeMA0GCSqGSIb3DQEBCwUAMHsxFDASBgNVBAoTC0dvb2dsZSBJ\n    bmMuMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MQ8wDQYDVQQDEwZHb29nbGUxGDAWBgNVBAsTD0dv\n    b2dsZSBGb3IgV29yazELMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWEwHhcNMjMwNzIx\n    MTcyODM0WhcNMjgwNzE5MTcyODM0WjB7MRQwEgYDVQQKEwtHb29nbGUgSW5jLjEWMBQGA1UEBxMN\n    TW91bnRhaW4gVmlldzEPMA0GA1UEAxMGR29vZ2xlMRgwFgYDVQQLEw9Hb29nbGUgRm9yIFdvcmsx\n    CzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A\n    MIIBCgKCAQEA2C9GM4JrOIk8k0B7rRJSwnx4jNdDFNou7LnWZ6B0wQrhPKc7KhbB+705M+u96o7A\n    PSTpmbbW/ZlI47/tctCiQOMgBjc/10pxI/smEONG99juQeSgpdkYMR9HTXO/8PTbGyKswyWsGLJo\n    M4Pe8qcSnwUiSMjDCcC56WV3MOAjwoYywYsZXm3y/Ug0Fb/thbK2lzJWu6aVDgssXfF9DQ0a42wk\n    B1EbtWy0Lo1oIjHOjUXtoK58sXEp5p13x/4wGYYvSaSK6hFvBgJ53R41wDRcce0Our5r3xA6LjjU\n    piQLj+mfntz4+WkGF4Ok6ibwdGiG1SRtLcG+KyusHn+Qu9JHGQIDAQABMA0GCSqGSIb3DQEBCwUA\n    A4IBAQAx11yQ6quWJzr9Nk7lkD8Wtj7PRAvpyKgwjW8i4OGXf3cvSM5tc2uiMc/0lgqU7Nlx0iQS\n    x5R8L4tPisFuESIHREz8jtQpp24U4n2XG8+E+gUo2yYw7D8Xha3l2JFlqCIwx/zlidEb8E8VYVxw\n    SUR6ywKpLdX7VJa02qpbUEhOTi86EBOYOfSxOnVokMFsKZ0pV/kAozxdQPo76xFxc+/nRDVQsZ9Y\n    6Tl4tE7KvzV1OrQN3T8b2sXGejZvc28XrOLdyWnPTx48rqKmwy0XVJQY3XdtkjIZSkWHpUU6L9XX\n    xHhtr/PB0PrIqJDN35q3sMxmIW41d/NdR8AcJZVDEje9</ds:X509Certificate></ds:X509Data></ds:KeyInfo></ds:Signature><saml2:Subject><saml2:NameID Format=\"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified\">ulysse.carion@codomaindata.com</saml2:NameID><saml2:SubjectConfirmation Method=\"urn:oasis:names:tc:SAML:2.0:cm:bearer\"><saml2:SubjectConfirmationData NotOnOrAfter=\"2023-11-16T21:25:27.514Z\" Recipient=\"https://example.com/accounts/bfeb03a0-6022-4862-9bbf-5a4d7608db35/saml/acs\"/></saml2:SubjectConfirmation></saml2:Subject><saml2:Conditions NotBefore=\"2023-11-16T21:15:27.514Z\" NotOnOrAfter=\"2023-11-16T21:25:27.514Z\"><saml2:AudienceRestriction><saml2:Audience>https://localhost:8080/accounts/bfeb03a0-6022-4862-9bbf-5a4d7608db35/saml</saml2:Audience></saml2:AudienceRestriction></saml2:Conditions><saml2:AuthnStatement AuthnInstant=\"2023-11-16T20:51:16.000Z\" SessionIndex=\"_6f7e3b62751ed5bf0adab64936da1e67\"><saml2:AuthnContext><saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:unspecified</saml2:AuthnContextClassRef></saml2:AuthnContext></saml2:AuthnStatement></saml2:Assertion></saml2p:Response>")))
}

//<saml2:Assertion xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" ID="_6f7e3b62751ed5bf0adab64936da1e67" IssueInstant="2023-11-16T21:20:27.514Z" Version="2.0"><saml2:Issuer>https://accounts.google.com/o/saml2?idpid=C029op2ga</saml2:Issuer><saml2:Subject><saml2:NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified">ulysse.carion@codomaindata.com</saml2:NameID><saml2:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer"><saml2:SubjectConfirmationData NotOnOrAfter="2023-11-16T21:25:27.514Z" Recipient="https://example.com/accounts/bfeb03a0-6022-4862-9bbf-5a4d7608db35/saml/acs"></saml2:SubjectConfirmationData></saml2:SubjectConfirmation></saml2:Subject><saml2:Conditions NotBefore="2023-11-16T21:15:27.514Z" NotOnOrAfter="2023-11-16T21:25:27.514Z"><saml2:AudienceRestriction><saml2:Audience>https://localhost:8080/accounts/bfeb03a0-6022-4862-9bbf-5a4d7608db35/saml</saml2:Audience></saml2:AudienceRestriction></saml2:Conditions><saml2:AuthnStatement AuthnInstant="2023-11-16T20:51:16.000Z" SessionIndex="_6f7e3b62751ed5bf0adab64936da1e67"><saml2:AuthnContext><saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:unspecified</saml2:AuthnContextClassRef></saml2:AuthnContext></saml2:AuthnStatement></saml2:Assertion>
//<saml2:Assertion xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion" ID="_6f7e3b62751ed5bf0adab64936da1e67" IssueInstant="2023-11-16T21:20:27.514Z" Version="2.0"><saml2:Issuer>https://accounts.google.com/o/saml2?idpid=C029op2ga</saml2:Issuer><ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"></ds:Signature><saml2:Subject><saml2:NameID Format="urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified">ulysse.carion@codomaindata.com</saml2:NameID><saml2:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer"><saml2:SubjectConfirmationData NotOnOrAfter="2023-11-16T21:25:27.514Z" Recipient="https://example.com/accounts/bfeb03a0-6022-4862-9bbf-5a4d7608db35/saml/acs"></saml2:SubjectConfirmationData></saml2:SubjectConfirmation></saml2:Subject><saml2:Conditions NotBefore="2023-11-16T21:15:27.514Z" NotOnOrAfter="2023-11-16T21:25:27.514Z"><saml2:AudienceRestriction><saml2:Audience>https://localhost:8080/accounts/bfeb03a0-6022-4862-9bbf-5a4d7608db35/saml</saml2:Audience></saml2:AudienceRestriction></saml2:Conditions><saml2:AuthnStatement AuthnInstant="2023-11-16T20:51:16.000Z" SessionIndex="_6f7e3b62751ed5bf0adab64936da1e67"><saml2:AuthnContext><saml2:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:unspecified</saml2:AuthnContextClassRef></saml2:AuthnContext></saml2:AuthnStatement></saml2:Assertion>
